## 简要介绍

Jsonl.sh是为SillyTavern写的自动存档脚本，可以设置“保留特定数字的倍数和最新楼层”“仅保留最新楼层”，防止丢失酒馆聊天记录。可在脚本内清理存档，也可直接在脚本内导入存档（已将存档压缩成xz文件，推荐脚本内直接导入）至酒馆。

**自定义规则基本没有测试，如有bug请随时反馈！**

由于此脚本的原理是扫描酒馆聊天文件并另存为，如果酒馆后台卡住没有保存成功修改，脚本不能捕捉到修改，不会生成存档。

可以尝试的解决办法：酒馆左下角-保存检查点，会生成名为Checkpoint…….jsonl的新文件。

## 安装及更新

### 安装

在termux输入：

* 直连：`git clone "https://github.com/Liu-fucheng/Jsonl_monitor.git"`
* 国内源：`curl -O "https://ghproxy.com/raw.githubusercontent.com/Liu-fucheng/Jsonl_monitor/main/jsonl.sh"`

### 更新

可直接在脚本内更新或输入以上代码更新

## 使用说明

（如正在运行一键脚本，需先退出原有脚本）在termux输入：`bash jsonl.sh`进入脚本

### 主菜单

#### 启动

启动监控，执行初始扫描（会扫描本地酒馆内的所有聊天记录文件），记录聊天行数，比对本地存档（默认不开启）。

初始扫描执行完毕后会实时扫描本地文件，记录聊天行数，按照设置中的规则保存存档。

#### 设置（必看！）

##### 1.保留机制

* `保留__的倍数和最新楼层`
* `仅保留最新楼层`
  
默认为保留20楼的倍数和最新楼层

由于大多数卡有开场白，默认保留的是20*n+1楼（即保留21、41、61楼）

如楼层较高可将数字拉大，如每100楼保留一次，楼层非常高（几千楼）可以在
[自定义规则](#3自定义规则)
中针对角色/聊天记录进行单独设置。

##### 2.回退处理

* `删除重写仅保留最新档（默认，减少占用内存）`
  删除楼层后重新生成（包括直接在酒馆内点“重新生成”而不是下一页）都只保留最新档，不保留旧档。
* `删除重写保留每个档（删除前的楼层无论是否符合保留机制均保留）`
  删除楼层后重新生成（包括直接在酒馆内点“重新生成”而不是下一页）保留每一个档，旧档会添加_old的后缀保存，如需删除可在mt管理器手动删除或清除冗余存档中清除。

##### 3.自定义规则
（未完整测试，bug可能非常多）

分为
* 全局规则
* 文件夹局部规则
  *角色规则（只对该角色起效）
  *聊天记录规则（只对该聊天记录起效）
